name: TypeScript to Lua Build and Validation

on:
  push:
    branches:
      - master
    paths-ignore:
      - 'README.md'
  pull_request:
    branches:
      - master
    paths-ignore:
      - 'README.md'

jobs:
  build-and-validate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22.19.0

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Build project
        run: pnpm run build

      - name: Check Lua syntax
        run: |
          sudo apt-get install -y lua5.3
          lua5.3 -e "assert(loadfile('index.lua'))"

      - name: Install TIC-80 dependencies
        run: |
          sudo apt-get update
          sudo apt-get install ruby-full libglvnd-dev libglu1-mesa-dev freeglut3-dev libasound2-dev libsamplerate0-dev doxygen libcurl4-openssl-dev -y
          sudo apt-get install build-essential -y

      - name: Checkout TIC-80
        run: |
          git clone https://github.com/nesbox/TIC-80.git
          cd TIC-80
          LATEST_TAG=$(git ls-remote --tags --sort="v:refname" origin | tail -n1 | sed 's/.*refs\/tags\///')
          git fetch origin tag $LATEST_TAG
          git checkout $LATEST_TAG
          # Initialize submodules
          git submodule init
          # Update submodules, handling the case where direct commit fetch fails
          # by manually cloning problematic submodules with full history
          git submodule update --recursive 2>&1 | tee /tmp/submodule.log || {
            # Extract failed submodule path from error message
            FAILED_SUBMODULE=$(grep -oE "submodule path '[^']*'|Fetched in submodule path '[^']*'" /tmp/submodule.log | head -1 | sed -E "s/.*submodule path '([^']*)'.*/\1/")
            if [ -n "$FAILED_SUBMODULE" ]; then
              echo "Attempting to fix submodule: $FAILED_SUBMODULE"
              COMMIT=$(git ls-tree HEAD "$FAILED_SUBMODULE" | awk '{print $3}')
              URL=$(git config -f .gitmodules --get "submodule.$FAILED_SUBMODULE.url")
              TOPLEVEL=$(pwd)
              rm -rf "$FAILED_SUBMODULE"
              # Clone with full history to ensure the commit is available
              git clone --no-single-branch "$URL" "$FAILED_SUBMODULE"
              cd "$FAILED_SUBMODULE"
              # Fetch all refs to ensure the commit is available, then checkout
              git fetch --all --tags
              git checkout "$COMMIT"
              cd "$TOPLEVEL"
            fi
            # Retry the update for remaining submodules
            git submodule update --recursive
          }
          echo "TIC-80_TAG=$LATEST_TAG" >> $GITHUB_ENV

      - name: Cache TIC-80 build
        uses: actions/cache@v4
        with:
          path: TIC-80/build
          key: tic80-build-${{ env.TIC-80_TAG }}
          restore-keys: |
            tic80-build-

      - name: Build TIC-80
        run: |
          cd TIC-80/build
          if [[ ! -f "bin/tic80" ]]; then
            cmake -DBUILD_PRO=On ..
            cmake --build . --parallel
          fi

      - name: Validate Lua files
        run: |
          OUTPUT=$(timeout -s KILL 10s ./TIC-80/build/bin/tic80 index.lua --cli || true)
          ERROR=$(echo "$OUTPUT" | awk -F'loading cart...' '/loading cart.../ {print $2}')
          if [[ -n "$ERROR" ]]; then
            echo "Validation failed."
            echo "Full output: $OUTPUT"
            exit 1
          else
            echo "Validation succeeded."
          fi
