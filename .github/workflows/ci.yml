name: Build and Validate

on:
  push:
    branches:
      - master
    paths-ignore:
      - README.md
  pull_request:
    branches:
      - master
    paths-ignore:
      - README.md
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    name: Build and Validate
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      TIC80_BUILD_DIR: TIC-80/build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest
          run_install: false

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24.11.1
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build TypeScript sources
        run: pnpm run build

      - name: Install Lua 5.3
        run: |
          sudo apt-get update
          sudo apt-get install -y lua5.3

      - name: Check Lua syntax
        run: lua5.3 -e "assert(loadfile('index.lua'))"

      - name: Resolve TIC-80 release
        id: tic80
        run: |
          latest_tag=$(
            git ls-remote --tags --sort="v:refname" https://github.com/nesbox/TIC-80.git \
            | grep -v '\^{}' \
            | tail -n 1 \
            | sed 's/.*\///'
          )
          echo "tag=$latest_tag" >> "$GITHUB_OUTPUT"
          echo "TIC80_TAG=$latest_tag" >> "$GITHUB_ENV"

      - name: Restore TIC-80 build cache
        id: tic80-cache
        uses: actions/cache@v4
        with:
          path: ${{ env.TIC80_BUILD_DIR }}
          key: tic80-build-${{ steps.tic80.outputs.tag }}
          restore-keys: |
            tic80-build-

      - name: Install TIC-80 build dependencies
        if: steps.tic80-cache.outputs.cache-hit != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ruby-full \
            libglvnd-dev \
            libglu1-mesa-dev \
            freeglut3-dev \
            libasound2-dev \
            libsamplerate0-dev \
            doxygen \
            libcurl4-openssl-dev \
            build-essential

      - name: Fetch TIC-80 source
        if: steps.tic80-cache.outputs.cache-hit != 'true'
        run: |
          git clone --depth 1 --branch "${{ steps.tic80.outputs.tag }}" --single-branch https://github.com/nesbox/TIC-80.git
          git -C TIC-80 submodule update --init --recursive

      - name: Build TIC-80
        if: steps.tic80-cache.outputs.cache-hit != 'true'
        run: |
          cmake -S TIC-80 -B "${{ env.TIC80_BUILD_DIR }}" -DBUILD_PRO=On
          cmake --build "${{ env.TIC80_BUILD_DIR }}" --parallel

      - name: Validate Lua files
        run: |
          OUTPUT=$(timeout -s KILL 10s "./${{ env.TIC80_BUILD_DIR }}/bin/tic80" index.lua --cli || true)
          ERROR=$(echo "$OUTPUT" | awk -F'loading cart...' '/loading cart.../ {print $2}')
          if [[ -n "$ERROR" ]]; then
            echo "Validation failed."
            echo "Full output: $OUTPUT"
            exit 1
          else
            echo "Validation succeeded."
          fi
